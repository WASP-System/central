<?xml version="1.0" encoding="UTF-8"?>
<beans
    xsi:schemaLocation=" http://www.springframework.org/schema/beans 
  http://www.springframework.org/schema/beans/spring-beans-3.1.xsd     
  http://www.springframework.org/schema/integration                   
  http://www.springframework.org/schema/integration/spring-integration.xsd
  http://www.springframework.org/schema/integration/file
  http://www.springframework.org/schema/integration/file/spring-integration-file.xsd"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:si="http://www.springframework.org/schema/integration" 
    xmlns:file="http://www.springframework.org/schema/integration/file" 
    xmlns="http://www.springframework.org/schema/beans"
    default-autowire="byName">
    
  <si:logging-channel-adapter id="wasp.logger" level="DEBUG"/>

  <!-- default error channel --> 
  <si:channel id="errorChannel">
    <si:interceptors>
      <si:wire-tap channel="wasp.logger"/>
    </si:interceptors>
  </si:channel>

  <!-- depreciated -->
  <bean id="taskService" class="edu.yu.einstein.wasp.service.impl.TaskServiceImpl" />


  <!-- Reads a state --> 
  <bean id="stateReader" class="edu.yu.einstein.wasp.batch.StateReader" scope="step">
    <property name="stateId" value="#{jobParameters['state']}"/>
  </bean>

  <bean id="filenameReader" class="edu.yu.einstein.wasp.batch.FilenameReader" scope="step">
    <property name="filename" value="#{jobParameters['filename']}"/>
  </bean>

  <!-- Placeholder Processor --> 
  <bean id="emptyStateProcessor" class="edu.yu.einstein.wasp.batch.EmptyStateProcessor" />

  <!-- Retry Policies -->
  <bean id="alwaysRetryPolicy" class="org.springframework.batch.retry.policy.AlwaysRetryPolicy" />
  <bean id="fixedBackoffPolicy" class="org.springframework.batch.retry.backoff.FixedBackOffPolicy">
    <property name="backOffPeriod" value="20000" />
  </bean>

  <!-- Parent of all the steps -->
  <bean id="parentStateStep" abstract="true" class="org.springframework.batch.core.step.item.FaultTolerantStepFactoryBean">
    <property name="transactionManager" ref="transactionManager"/>
    <property name="jobRepository" ref="jobRepository"/>
    <property name="itemReader" ref="stateReader"/>
    <property name="retryableExceptionClasses">
      <map>
        <entry key="edu.yu.einstein.wasp.batch.RetryableException" value="true" />
      </map>
    </property>
    <property name="retryPolicy" ref="alwaysRetryPolicy" />
    <property name="backOffPolicy" ref="fixedBackoffPolicy" />
  </bean>

  <bean id="parentFileStep" abstract="true" parent="parentStateStep">
    <property name="itemReader" ref="filenameReader"/>
  </bean>

  <!-- Placeholder empty state -->
  <bean id="emptyStateStep" parent="parentStateStep"> 
    <property name="itemProcessor" ref="emptyStateProcessor"/>
  </bean>

</beans>
