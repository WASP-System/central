<?xml version="1.0" encoding="UTF-8"?>
<beans
    xsi:schemaLocation=" http://www.springframework.org/schema/beans 
  http://www.springframework.org/schema/beans/spring-beans-3.1.xsd     
  http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration-2.0.xsd
  http://www.springframework.org/schema/batch 
  http://www.springframework.org/schema/batch/spring-batch-2.1.xsd
  "
    xmlns:p="http://www.springframework.org/schema/p" 
    xmlns:batch="http://www.springframework.org/schema/batch" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:si="http://www.springframework.org/schema/integration" 
    xmlns="http://www.springframework.org/schema/beans"
    default-autowire="byName">

  <bean abstract="true" id="wasp.run.ResourceCategoryPoller" class="edu.yu.einstein.wasp.batch.poller.WorkflowResourceCategoryRunPoller" />


  <!-- /** TEMPLATE **/

  /** everything below can be used a template **/
  /** everything below can be used a template **/
  /** everything below can be used a template **/


  <bean id="wasp.run.Poller" parent="wasp.run.ResourceCategoryPoller">
    <property name="resourceCategoryIName" value="illuminaHiSeq2000"/>
    <property name="taskIName" value="runWrapTask"/>
  </bean>

  <si:inbound-channel-adapter ref="wasp.run.ResourceCategoryPoller" method="getStates" channel="wasp.run.Channel">
    <si:poller fixed-rate="2000"/>
  </si:inbound-channel-adapter>

  <si:service-activator input-channel="wasp.run.Channel" output-channel="logger">
    <bean class="edu.yu.einstein.wasp.batch.launcher.StateJobLaunchingMessageHandler" scope="prototype">
       <constructor-arg ref="jobRegistry" />
       <constructor-arg ref="jobLauncher" />
       <constructor-arg ref="jobRepository" />
       <constructor-arg ref="jobOperator" />
       <constructor-arg type="java.lang.String"><value>wasp.run.Job</value></constructor-arg>
    </bean>
  </si:service-activator>



  /* GetResults */
                                                                                  <bean id="wasp.run.GetResultsStep" parent="parentStateStep">
    <property name="itemProcessor">
      <bean class="edu.yu.einstein.wasp.batch.WaitForRunFileProcessor">
        <property name="filenameRegex" value=".*\.completed.txt" />
      </bean>
    </property>
  </bean>

  <batch:flow id="wasp.run.GetResultsFlow">
    <batch:step id="wasp.run.GetResultsFlow0" parent="wasp.run.GetResultsStep" />
  </batch:flow> 


  /* /GetResults */

  /* qcRun */
  <bean id="wasp.run.CreateQcApprovalStateStep" parent="parentStateStep">
    <property name="itemProcessor">
      <bean class="edu.yu.einstein.wasp.batch.CreateSampleStateProcessor">
        <property name="targetTask" value="runQcApproval" />
      </bean>
    </property>
  </bean>

  <bean id="wasp.run.WaitForQcApprovalStateStep" parent="parentStateStep">
    <property name="itemProcessor">
      <bean class="edu.yu.einstein.wasp.batch.WaitForSiblingRunStateProcessor">
        <property name="task" value="runQcApproval" />
        <property name="status" value="APPROVED" />
        <property name="siblingTargetStatus" value="FINALIZED" />
      </bean>
    </property>
  </bean>

  <batch:flow id="wasp.run.QcApprovalFlow">
    <batch:step id="wasp.run.QcApprovalStep0" parent="wasp.run.CreateQcApprovalStateStep" next="wasp.run.QcApprovalStep1" />
    <batch:step id="wasp.run.QcApprovalStep1" parent="wasp.run.WaitForQcApprovalStateStep" />
  </batch:flow>

  /* /qcRun */


  /* default run flow */
  <batch:flow id="wasp.run.Flow">
    <batch:flow id="wasp.run.Flow0" parent="wasp.run.GetResultsFlow" next="wasp.run.Flow1" />
    <batch:flow id="wasp.run.Flow1" parent="wasp.run.QcApprovalFlow" />
  </batch:flow>
  /* default run flow */

  /* default run job flow */
  <batch:job id="wasp.run.Job">
    <batch:flow id="wasp.run.Job0" parent="wasp.run.Flow" next="wasp.run.Job1" />

    <batch:flow id="wasp.run.Job1" parent="wasp.default.FinalFlow" />
  </batch:job>
  /* default run job flow */


  ******************************************************* -->


</beans>
