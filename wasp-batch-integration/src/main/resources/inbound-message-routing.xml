<?xml version="1.0" encoding="UTF-8"?>
<beans
	xsi:schemaLocation=" http://www.springframework.org/schema/beans 
  http://www.springframework.org/schema/beans/spring-beans.xsd     
  http://www.springframework.org/schema/context  
  http://www.springframework.org/schema/context/spring-context.xsd 
  http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration.xsd
  http://www.springframework.org/schema/integration/file
  http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
  http://www.springframework.org/schema/integration/rmi
  http://www.springframework.org/schema/integration/rmi/spring-integration-rmi-2.1.xsd
  http://www.springframework.org/schema/batch 
  http://www.springframework.org/schema/batch/spring-batch.xsd
  http://www.springframework.org/schema/integration/ip
  http://www.springframework.org/schema/integration/ip/spring-integration-ip.xsd
  "
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:batch="http://www.springframework.org/schema/batch"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:file="http://www.springframework.org/schema/integration/file"
	xmlns:rmi="http://www.springframework.org/schema/integration/rmi"
	xmlns:ip="http://www.springframework.org/schema/integration/ip"
	xmlns="http://www.springframework.org/schema/beans">
	
	<!-- default logging channel -->
	<int:logging-channel-adapter id='wasp.channel.defaultLogging' log-full-message="true" level="DEBUG" />
	
	<!-- primary message channel. Broadcasts incoming messages to registered listeners -->
    <int:publish-subscribe-channel id="wasp.channel.primaryMessage" >
    	<int:interceptors>
	    	<int:wire-tap channel="wasp.channel.defaultLogging" />
	    </int:interceptors>
    </int:publish-subscribe-channel>
    
    <!-- Main channel to send replies via gateway. Messages will be routed to correct gateway -->
    <int:channel id="wasp.channel.primaryReply" >
    	<int:interceptors>
	    	<int:wire-tap channel="wasp.channel.defaultLogging" />
	    </int:interceptors>
    </int:channel>
	
	    	
    <!-- channel for messages to enter from within components of the WASP System -->
    <int:channel id="wasp.channel.rmi.inbound" />
    <int:channel id="wasp.channel.rmi.internal.reply" />
    
        	
    <!-- defines a route to inject messages into the system from within the WASP System-->
    <rmi:inbound-gateway id="internalRmiGateway"
    	request-channel="wasp.channel.rmi.inbound" 
    	reply-channel="wasp.channel.rmi.internal.reply" 
    	registry-port="23532" />
    	
    <int:header-enricher input-channel="wasp.channel.rmi.inbound" output-channel="wasp.channel.Authenticated1">
		<int:header name="gateway-reply-channel" value="wasp.channel.rmi.internal.reply" />
	</int:header-enricher>
    	
    
    <!-- channel to port messages requiring authentication from outside the application -->
    <int:channel id="wasp.channel.rmi.secure.inbound0" />
    <int:channel id="wasp.channel.rmi.secure.inbound1" />
    <int:channel id="wasp.channel.rmi.secure.reply" />
        
    <!-- defines a secure route to inject messages into the system from outside the WASP System-->
    <rmi:inbound-gateway id="externalSecureRmiGateway"
    	request-channel="wasp.channel.rmi.secure.inbound0" 
    	reply-channel="wasp.channel.rmi.secure.reply"
    	registry-port="23532" />
    
	<int:header-enricher input-channel="wasp.channel.rmi.secure.inbound0" output-channel="wasp.channel.rmi.secure.inbound1">
		<int:header name="gateway-reply-channel" value="wasp.channel.rmi.secure.reply" />
	</int:header-enricher>
    
    <!-- channel to return messages when authentication fails -->
    <int:channel id="wasp.channel.failedLogin" >
    	<int:interceptors>
	    	<int:wire-tap channel="wasp.channel.defaultLogging" />
	    </int:interceptors>
	</int:channel>
    
    
    <!-- authenticating bean -->
	<bean id="waspSecurityCheck" class="edu.yu.einstein.wasp.messaging.Security" />
	
	<!-- test for proper authentication -->
    <int:filter input-channel="wasp.channel.rmi.secure.inbound1" 
		ref="waspSecurityCheck" 
		output-channel="wasp.channel.Authenticated0" 
		discard-channel="wasp.channel.failedLogin" />
		
	<int:header-filter input-channel="wasp.channel.Authenticated0" output-channel="wasp.channel.Authenticated1"	header-names="password"/>
		
	<int:header-enricher input-channel="wasp.channel.Authenticated1" output-channel="wasp.channel.primaryMessage">
		<int:header name="destination" expression="'wasp.channel.'.concat(headers.get('target'))" />
	</int:header-enricher>
	
		 	
	<!-- indicate failed connection attempt by setting header value "authenticated=false" -->
	<int:header-enricher id="wasp.header-encricher.failedLogin" 
		input-channel="wasp.channel.failedLogin"
		output-channel="wasp.channel.rmi.secure.reply">
		<int:header name="authenticated" value="false"/>
	</int:header-enricher>
	
	<!-- channel that handles messages with unknown destinations -->
    <int:channel id="wasp.channel.unknown" />
	
	<!-- return messages with unknown target to sender -->
	<int:header-enricher id="wasp.header-encricher.unknown-target" 
		input-channel="wasp.channel.unknown"
		output-channel="wasp.channel.primaryReply">
		<int:header name="unknown-target" value="true"/>
	</int:header-enricher>
	
	<!-- routes messages to channel specified in 'destination' header -->
	<int:header-value-router input-channel="wasp.channel.primaryMessage"
		header-name="destination" 
		default-output-channel="wasp.channel.unknown"
		resolution-required="false" />
		
	<!-- Routes messages correctly via gateway-reply-channel header  -->
	<int:header-value-router input-channel="wasp.channel.primaryReply" 
		header-name="gateway-reply-channel" 
		resolution-required="true" />
		
    <int:channel id="wasp.channel.echo" />	
    	
    <int:service-activator input-channel="wasp.channel.echo" 
		ref="echoService"
		method="process" 
		output-channel="wasp.channel.primaryReply" />
		
	<bean id="echoService"	class="edu.yu.einstein.wasp.messaging.EchoService" />
	
	
		
</beans>
