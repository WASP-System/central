<?xml version="1.0" encoding="UTF-8"?>
<beans
    xsi:schemaLocation=" http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
  http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration-2.0.xsd
  http://www.springframework.org/schema/batch
  http://www.springframework.org/schema/batch/spring-batch-2.1.xsd
  http://www.springframework.org/schema/integration/file
  http://www.springframework.org/schema/integration/file/spring-integration-file-2.0.xsd"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:batch="http://www.springframework.org/schema/batch"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:si="http://www.springframework.org/schema/integration"
    xmlns:file="http://www.springframework.org/schema/integration/file"
    xmlns="http://www.springframework.org/schema/beans"
    default-autowire="byName">


  <!-- most effective if filename-regex matches registerfile.filnameRegex -->
  <file:inbound-channel-adapter id="files" 
        directory="/tmp/t" 
        filename-regex="file.*txt"
        prevent-duplicates="true"
        channel="fileInputChannel"> 
    <si:poller>
      <si:interval-trigger interval="2000" />
    </si:poller>
  </file:inbound-channel-adapter>


  <si:service-activator input-channel="fileInputChannel" output-channel="logger">
    <bean class="edu.yu.einstein.wasp.batch.launcher.FileLaunchingMessageHandler" scope="prototype">
        <constructor-arg ref="jobRegistry" />
        <constructor-arg ref="jobLauncher" />
        <constructor-arg ref="jobRepository" />
        <constructor-arg ref="jobOperator" />
       
        <constructor-arg type="java.lang.String"><value>fileJob</value></constructor-arg> 
    </bean>
  </si:service-activator> 

  <bean class="edu.yu.einstein.wasp.batch.DoCommandFileTasklet" id="abcFileTasklet" scope="step">
    <property name="filename">
      <value>#{jobParameters['filename']}</value>
    </property>
    <property name="params">
      <list>
        <value>'/tmp/abc.pl'</value>
        <value>'goodbye'</value>
        <value>'#{jobParameters['filename']}'</value>
        <value>'goodbye'</value>
      </list>
    </property>

    <!-- 5 second timeout for the command to complete -->
    <property name="timeout" value="5000" />
  </bean>


  <bean id="illuminaRegisterFileStep" parent="parentFileStep">
    <property name="itemProcessor">
      <bean class="edu.yu.einstein.wasp.batch.RegisterFileProcessor">
        <property name="filenameRegex" value=".*file\.(\d*)\.(\d*)\.(\d*).*\.txt$" />

        <property name="matchList">
          <list>
            <value>jobId</value> 
            <value>runId</value> 
            <value>sampleId</value>  
          </list>
        </property>
      </bean>
    </property>
  </bean>
  

  
  <batch:job id="fileJob" restartable="true">
    <batch:step id="fileJob0" parent="illuminaRegisterFileStep" next="fileJob1" />
    <batch:step id="fileJob1">
      <batch:tasklet ref="abcFileTasklet" />
    </batch:step> 

  </batch:job>


</beans>

