<?xml version="1.0" encoding="UTF-8"?>
<beans
    xsi:schemaLocation=" http://www.springframework.org/schema/beans 
  http://www.springframework.org/schema/beans/spring-beans-3.1.xsd     
  http://www.springframework.org/schema/context  
  http://www.springframework.org/schema/context/spring-context-3.1.xsd 
  http://www.springframework.org/schema/mvc 
  http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd  
  http://www.springframework.org/schema/aop 
  http://www.springframework.org/schema/aop/spring-aop-3.1.xsd
  http://www.springframework.org/schema/tx
  http://www.springframework.org/schema/tx/spring-tx-3.1.xsd
  http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration-2.0.xsd
  http://www.springframework.org/schema/integration/file
  http://www.springframework.org/schema/integration/file/spring-integration-file-2.0.xsd"
    xmlns:mvc="http://www.springframework.org/schema/mvc" xmlns:aop="http://www.springframework.org/schema/aop" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:p="http://www.springframework.org/schema/p" xmlns:tx="http://www.springframework.org/schema/tx" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:si="http://www.springframework.org/schema/integration" xmlns:file="http://www.springframework.org/schema/integration/file" xmlns="http://www.springframework.org/schema/beans"
    default-autowire="byName">
    
  <si:logging-channel-adapter id="logger" level="DEBUG"/>

  <!-- default error channel --> 
  <si:channel id="errorChannel">
    <si:interceptors>
      <si:wire-tap channel="logger"/>
    </si:interceptors>
  </si:channel>

  <!-- depreicated -->
  <bean id="taskService" class="edu.yu.einstein.wasp.service.impl.TaskServiceImpl" />


  <!-- for <batch:split> an parallel action -->
  <bean id="asyncTaskExecutor" class="org.springframework.core.task.SimpleAsyncTaskExecutor" />


  <!-- Reads a state --> 
  <bean id="stateReader" class="edu.yu.einstein.wasp.batch.StateReader" scope="step">
    <property name="stateId" value="#{jobParameters['state']}"/>
  </bean>

  <bean id="emptyStateProcessor" class="edu.yu.einstein.wasp.batch.EmptyStateProcessor" />

  <bean id="alwaysRetryPolicy" class="org.springframework.batch.retry.policy.AlwaysRetryPolicy" />

  <bean id="fixedBackoffPolicy" class="org.springframework.batch.retry.backoff.FixedBackOffPolicy">
    <property name="backOffPeriod" value="10000" />
  </bean>

  <bean id="parentStateStep" abstract="true" class="org.springframework.batch.core.step.item.FaultTolerantStepFactoryBean">
    <property name="transactionManager" ref="transactionManager"/>
    <property name="jobRepository" ref="jobRepository"/>
    <property name="itemReader" ref="stateReader"/>
    <property name="retryableExceptionClasses">
      <map>
        <entry key="edu.yu.einstein.wasp.batch.RetryableException" value="true" />
      </map>
    </property>
    <property name="retryPolicy" ref="alwaysRetryPolicy" />
    <property name="backOffPolicy" ref="fixedBackoffPolicy" />
  </bean>

  <bean id="emptyStateStep" parent="parentStateStep"> 
    <property name="itemProcessor" ref="emptyStateProcessor"/>
  </bean>

  <bean id="finalStateStep" parent="parentStateStep">
    <property name="itemProcessor">
      <bean class="edu.yu.einstein.wasp.batch.StateFinalProcessor"/>
    </property>
  </bean>

</beans>
